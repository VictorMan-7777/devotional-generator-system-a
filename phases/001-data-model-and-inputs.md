# Phase 001 — Data Model & Inputs

**Project**: devotional-generator-system-a
**Phase**: 001
**Version**: 1.0
**Date**: 2026-02-24
**Status**: APPROVED — 2026-02-24

---

## Objective

Establish the foundational data contracts, schemas, and input handling layer that all subsequent phases depend on. Define and finalize the Python/TypeScript language boundary. Stand up scripture retrieval. This phase must close with `constitution.md` operator-approved before any Phase 002 implementation begins.

**Why this phase is necessary:** All other phases depend on stable, typed schemas. Phase 002 templates consume `DailyDevotional`. Phase 003 PDF engine consumes `DocumentRepresentation`. Phase 004 validators and AC Scoring Harness depend on the schema being final. Changing schemas after Phase 001 closes causes rework across all phases.

**Success definition:** All schemas are defined, reviewed, and frozen. Mock RAG interface contract is finalized. Scripture retrieval passes integration tests against Bolls.life. `constitution.md` is operator-approved. Series Registry persists across process restarts.

---

## Prerequisites

- Authoritative PRD v16 read and understood
- `constitution.md` draft exists (created by Planner)
- `devotional-generator-system-a/` project directory exists
- Python 3.11+ available
- No Phase 002 or 003 implementation has started

---

## Inputs

- PRD v16: Section 5 (daily structure), Section 7 (inputs), Section 9 (FRs), Section 10.6 (scripture sources), Sections 9.8–9.9 (registry), TC-01–TC-06
- `constitution.md` draft
- Bolls.life API reference (PRD Appendix A)

---

## Outputs

| File | Description |
|------|-------------|
| `src/models/devotional.py` | Pydantic schemas: DevotionalInput, DailyDevotional, all section schemas |
| `src/models/artifacts.py` | GroundingMap, PrayerTraceMap schemas |
| `src/models/registry.py` | SeriesRegistry, VolumeRecord, QuoteRecord schemas |
| `src/interfaces/rag.py` | Mock RAG interface contract (quote retrieval + exposition RAG) |
| `src/scripture/retrieval.py` | Scripture retrieval module (Bolls.life → API.Bible → operator import) |
| `src/scripture/book_ids.py` | Bolls.life book ID mapping table |
| `src/registry/registry.py` | Series Registry implementation (SQLite-backed) |
| `constitution.md` | Operator-approved Python/TypeScript boundary (updated from draft) |
| `tests/test_schemas.py` | Schema validation unit tests |
| `tests/test_scripture_retrieval.py` | Scripture retrieval integration tests |
| `tests/test_registry.py` | Registry persistence tests |

---

## Steps

### Step 1: Project Scaffold

1. Create project directory structure:
   ```text
   devotional-generator-system-a-app/   (or agreed application root)
   ├── src/
   │   ├── models/
   │   ├── interfaces/
   │   ├── scripture/
   │   ├── registry/
   │   └── api/
   ├── tests/
   ├── pyproject.toml
   └── README.md
   ```
2. Initialize Python project with `pyproject.toml` (or `setup.py`): Python 3.11+, Pydantic v2, FastAPI, SQLAlchemy, pytest
3. Confirm Python version with `python --version`
4. Install dependencies: `pip install -e ".[dev]"` or equivalent

### Step 2: Core Pydantic Schemas

Define all Pydantic models for the devotional domain:

**`src/models/devotional.py`**

```python
# Key schemas (illustrative — full implementation in Builder phase):

class SectionApprovalStatus(str, Enum):
    PENDING = "pending"
    APPROVED = "approved"

class OutputMode(str, Enum):
    PERSONAL = "personal"
    PUBLISH_READY = "publish-ready"

class DevotionalInput(BaseModel):
    topic: str                          # Required
    num_days: int = Field(default=6, ge=1, le=7)
    scripture_version: str = "NASB"
    output_mode: OutputMode = OutputMode.PUBLISH_READY
    title: Optional[str] = None         # Autogenerated if absent
    day_focus: Optional[List[str]] = None  # Per-day sub-themes

class TimelessWisdomSection(BaseModel):
    quote_text: str
    author: str
    source_title: str
    publication_year: Optional[int]
    page_or_url: str
    public_domain: bool
    verification_status: str            # "catalog_verified" | "human_approved"
    approval_status: SectionApprovalStatus = SectionApprovalStatus.PENDING

class ScriptureSection(BaseModel):
    reference: str                      # e.g. "Romans 8:15"
    text: str
    translation: str
    retrieval_source: str               # "bolls_life" | "api_bible" | "operator_import"
    verification_status: str
    approval_status: SectionApprovalStatus = SectionApprovalStatus.PENDING

class ExpositionSection(BaseModel):
    text: str                           # Full 500–700 word text
    word_count: int
    grounding_map_id: str               # FK to GroundingMap
    approval_status: SectionApprovalStatus = SectionApprovalStatus.PENDING

class BeStillSection(BaseModel):
    prompts: List[str]                  # 3–5 prompts
    approval_status: SectionApprovalStatus = SectionApprovalStatus.PENDING

class ActionStepsSection(BaseModel):
    items: List[str]                    # 1–3 items
    connector_phrase: str
    approval_status: SectionApprovalStatus = SectionApprovalStatus.PENDING

class PrayerSection(BaseModel):
    text: str                           # 120–200 words
    word_count: int
    prayer_trace_map_id: str            # FK to PrayerTraceMap
    approval_status: SectionApprovalStatus = SectionApprovalStatus.PENDING

class SendingPromptSection(BaseModel):  # Day 6, only when Day 7 enabled
    text: str                           # 40–80 words
    word_count: int
    approval_status: SectionApprovalStatus = SectionApprovalStatus.PENDING

class Day7Section(BaseModel):           # Only when num_days == 7
    before_service: str                 # 50–80 words
    after_service_track_a: List[str]    # 2–3 prompts + closing question
    after_service_track_b: List[str]    # 2–3 prompts + closing question
    after_service_word_count: int       # Must be 120–180
    approval_status: SectionApprovalStatus = SectionApprovalStatus.PENDING

class DailyDevotional(BaseModel):
    day_number: int                     # 1–7
    day_focus: Optional[str] = None
    timeless_wisdom: TimelessWisdomSection
    scripture: ScriptureSection
    exposition: ExpositionSection
    be_still: BeStillSection
    action_steps: ActionStepsSection
    prayer: PrayerSection
    sending_prompt: Optional[SendingPromptSection] = None  # Day 6 only
    day7: Optional[Day7Section] = None                     # Day 7 only
    created_at: datetime
    last_modified: datetime

class DevotionalBook(BaseModel):
    id: str                             # UUID
    input: DevotionalInput
    days: List[DailyDevotional]
    series_id: Optional[str] = None
    volume_number: Optional[int] = None
```

### Step 3: Artifact Schemas

**`src/models/artifacts.py`**

```python
class GroundingMapEntry(BaseModel):
    paragraph_number: int               # 1–4 (declaration, context, theological, bridge)
    paragraph_name: str
    sources_retrieved: List[str]        # Document names retrieved
    excerpts_used: List[str]            # Specific passages drawn upon
    how_retrieval_informed_paragraph: str  # One-sentence statement

class GroundingMap(BaseModel):
    id: str                             # UUID
    exposition_id: str
    entries: List[GroundingMapEntry]    # Must have exactly 4 entries

    @field_validator("entries")
    @classmethod
    def must_have_four_entries(cls, v):
        if len(v) != 4:
            raise ValueError("GroundingMap must have exactly 4 entries")
        if not all(e.sources_retrieved and e.excerpts_used for e in v):
            raise ValueError("All GroundingMap entries must be non-empty")
        return v

class PrayerTraceMapEntry(BaseModel):
    element_text: str                   # The petition, address, or thematic element
    source_type: str                    # "scripture" | "exposition" | "be_still"
    source_reference: str               # Specific verse/sentence/prompt being referenced

class PrayerTraceMap(BaseModel):
    id: str                             # UUID
    prayer_id: str
    entries: List[PrayerTraceMapEntry]  # One per prayer element; no untraceable elements

    @field_validator("entries")
    @classmethod
    def no_untraceable_elements(cls, v):
        invalid = [e for e in v if e.source_type not in ("scripture", "exposition", "be_still")]
        if invalid:
            raise ValueError("All prayer elements must be traceable to scripture, exposition, or be_still")
        return v
```

### Step 4: Series Registry Schemas and Implementation

**`src/models/registry.py`** — schema definitions

**`src/registry/registry.py`** — SQLite-backed implementation:
- `add_quote(volume_id, quote_text, author, source)` — stores quote, checks for within-volume duplicates
- `check_series_duplicate(series_id, quote_text)` — checks cross-volume duplication
- `add_scripture(volume_id, reference, translation)` — stores scripture usage
- `check_scripture_duplicate(volume_id, reference)` — within-volume warning
- `get_author_distribution(series_id, attribute)` — returns count per author
- `get_parent_distribution(parent_volume_id, attribute)` — for child volume weighting
- `backup(volume_id, backup_path)` — backup on volume export
- Encryption integration point: registry file encrypted at rest (implemented in Phase 004)

### Step 5: Mock RAG Interface Contract

**`src/interfaces/rag.py`** — defines the interface that both mock and real implementations must satisfy:

```python
class QuoteRAGInterface(Protocol):
    def retrieve_quotes(
        self,
        topic: str,
        scripture_reference: str,
        author_weights: Optional[Dict[str, float]] = None,
        top_k: int = 10,
    ) -> List[QuoteCandidate]:
        """
        Returns candidate quotes from the Quote Catalog.
        Returns at least 3 candidates if available.
        Returns fewer if catalog is thin; triggers shortage protocol if < 3.
        """
        ...

class ExpositionRAGInterface(Protocol):
    def retrieve_for_paragraph(
        self,
        paragraph_type: str,    # "context" | "theological"
        passage_reference: str,
        topic: str,
        source_types: List[str],  # "commentary" | "reference"
    ) -> List[RetrievedExcerpt]:
        """
        Returns retrieved excerpts from approved theological sources.
        paragraph_type determines which sources are queried (FR-18).
        """
        ...
```

**`src/interfaces/mock_rag.py`** — concrete mock implementations returning fixture data.

**Rule:** Phase 002 and Phase 003 use only the mock implementations. Real implementations are swapped in during Phase 004.

### Step 6: Scripture Retrieval Module

**`src/scripture/book_ids.py`** — Bolls.life book ID mapping table (from PRD Appendix A.11):
- Dict mapping standard book names and abbreviations to integer IDs
- Must cover all 66 books of the Bible plus common abbreviations

**`src/scripture/retrieval.py`** — retrieval module implementing FR-57–FR-59:

```python
class ScriptureRetriever:
    def retrieve(
        self,
        reference: str,
        translation: str = "NASB",
        operator_import: Optional[Path] = None,
    ) -> ScriptureResult:
        """
        Priority chain:
        1. Try Bolls.life API (with one retry per FR-59a)
        2. Try API.Bible if key present in config (FR-59b)
        3. Try operator import file if path provided (FR-59c)
        4. Return failure alert (FR-59d,e,f)
        """
        ...

    def validate_match(self, response: dict, reference: str, translation: str) -> bool:
        """
        Validated match per FR-58 and Section 10.6:
        - translation field matches requested code
        - book, chapter, verse fields match reference
        - text field non-empty after HTML tag stripping
        """
        ...
```

Integration tests must cover:
- Successful retrieval from Bolls.life for a known verse (NASB Romans 8:15)
- Retry behavior on simulated failure (mock HTTP 500)
- Fallback to API.Bible when primary fails (mock)
- Fallback to operator import file
- Full-failure structured alert format

### Step 7: `constitution.md` Review and Finalization

1. Present `constitution.md` draft to operator for review
2. Operator reviews Python/TypeScript boundary, technology choices, API approach
3. Apply any operator corrections
4. Mark `constitution.md` as operator-approved
5. No Phase 001 builder work proceeds until this step is complete

### Step 8: PDF Library Spike (Non-Blocking Parallel)

While other Phase 001 work proceeds, run a spike test on TypeScript PDF libraries:
- Test `pdf-lib` and `React-PDF/renderer` against Phase 003 requirements
- Key tests: embed a TTF font; apply dynamic margins; place a footnote at page bottom
- Document results in `docs/system/outputs/` (Phase 001 date, spike context)
- Select PDF library before Phase 003 begins

This is non-blocking for Phase 001 commit points but must complete before Phase 003 starts.

---

## Commit Points

### CP1: Project Scaffold

**Files to Stage:**
- `pyproject.toml`
- `src/__init__.py`
- `src/models/__init__.py`
- `tests/__init__.py`
- `README.md` (application README)

**Commit Command:**
```bash
git add pyproject.toml src/__init__.py src/models/__init__.py tests/__init__.py README.md
git commit -m "feat(phase-001): project scaffold — python structure and dependencies"
```

**Verification:**
- `python -c "import pydantic; print(pydantic.__version__)"` shows v2.x
- `pytest tests/` runs without error (no tests yet, just confirms test runner works)

**Rollback:**
```bash
git reset --soft HEAD~1
```

---

### CP2: Core Schemas and Artifacts

**Files to Stage:**
- `src/models/devotional.py`
- `src/models/artifacts.py`
- `src/models/registry.py`
- `tests/test_schemas.py`

**Commit Command:**
```bash
git add src/models/devotional.py src/models/artifacts.py src/models/registry.py tests/test_schemas.py
git commit -m "feat(phase-001): core pydantic schemas — devotional, grounding map, prayer trace map, registry"
```

**Verification:**
- `pytest tests/test_schemas.py -v` all pass
- Schema includes all 6 section types with approval_status fields
- GroundingMap validator rejects fewer than 4 entries
- PrayerTraceMap validator rejects untraceable elements
- DevotionalInput accepts num_days 1–7; rejects 0 and 8

**Rollback:**
```bash
git reset --soft HEAD~1
```

---

### CP3: Mock RAG Interface Contract

**Files to Stage:**
- `src/interfaces/rag.py`
- `src/interfaces/mock_rag.py`
- `tests/test_interfaces.py`

**Commit Command:**
```bash
git add src/interfaces/rag.py src/interfaces/mock_rag.py tests/test_interfaces.py
git commit -m "feat(phase-001): mock RAG interface contract — quote and exposition retrieval"
```

**Verification:**
- Mock quote retrieval returns ≥3 fixture candidates for any topic
- Mock exposition retrieval returns fixture excerpts for each paragraph type
- Interface contract uses Python Protocol; mypy passes on interface definitions

**Rollback:**
```bash
git reset --soft HEAD~1
```

---

### CP4: Scripture Retrieval Module

**Files to Stage:**
- `src/scripture/book_ids.py`
- `src/scripture/retrieval.py`
- `tests/test_scripture_retrieval.py`

**Commit Command:**
```bash
git add src/scripture/book_ids.py src/scripture/retrieval.py tests/test_scripture_retrieval.py
git commit -m "feat(phase-001): scripture retrieval — bolls.life primary, api.bible secondary, operator import fallback"
```

**Verification:**
- Live test: `ScriptureRetriever().retrieve("Romans 8:15", "NASB")` returns text containing "Spirit of adoption"
- HTML tags stripped from returned text
- Retry test (mocked): single HTTP 500 triggers retry; second 500 falls to API.Bible
- Operator import test: CSV file with Romans 8:15 bypasses API; returns correct text
- Full failure test: returns structured alert with passage and failure mode

**Rollback:**
```bash
git reset --soft HEAD~1
# Note: no database state at this point; rollback is clean
```

---

### CP5: Series Registry

**Files to Stage:**
- `src/registry/registry.py`
- `tests/test_registry.py`

**Commit Command:**
```bash
git add src/registry/registry.py tests/test_registry.py
git commit -m "feat(phase-001): series registry — sqlite persistence, de-duplication, author distribution"
```

**Verification:**
- `test_registry.py` covers:
  - `add_quote()` stores quote; second call with same quote fails within-volume check
  - `check_series_duplicate()` flags quote present in previous volume
  - `add_scripture()` stores passage; duplicate in same volume returns warning
  - `get_author_distribution()` returns correct counts after several quotes added
  - Registry state survives process restart (write → exit → relaunch → read same data)
  - `backup()` creates a copy of the registry file at specified path

**Rollback:**
```bash
git reset --soft HEAD~1
rm -f tests/fixtures/test_registry.db  # remove any test database artifacts
```

---

## Acceptance Criteria

Phase 001 is complete when:

- [ ] All Pydantic schemas pass mypy type checking with no errors
- [ ] `pytest tests/` passes all tests in Phase 001 test files
- [ ] `DevotionalInput` schema enforces `num_days` 1–7
- [ ] `GroundingMap` rejects fewer than 4 entries or any empty entry
- [ ] `PrayerTraceMap` rejects entries not mapped to scripture, exposition, or be_still
- [ ] Mock RAG interface returns fixture data without external calls
- [ ] Scripture retrieval successfully fetches Romans 8:15 from Bolls.life (live test)
- [ ] Scripture retrieval falls through fallback chain correctly (mock tests)
- [ ] Structured alert produced on complete retrieval failure
- [ ] Series Registry persists across process restarts (verified by test)
- [ ] Registry backup function creates correct file copy
- [ ] `constitution.md` is operator-approved
- [ ] PDF library spike test results documented (even if library not yet selected)
- [ ] All commit points (CP1–CP5) executed and verified

---

## Rollback Notes

**Emergency rollback (all of Phase 001):**
```bash
git log --oneline  # Find the commit before Phase 001 started
git reset --soft <pre-phase-001-commit-hash>
```

State returns to: empty project directory, no schemas, no tests. Phase 002 and 003 cannot proceed without Phase 001 schemas. Complete restart of Phase 001 required.

**Partial rollback:** Each CP is independently reversible via `git reset --soft HEAD~1`. No database operations occur until CP5; CP1–CP4 rollbacks are clean.

---

## Verification Steps

1. `python --version` → shows 3.11+
2. `python -c "import pydantic; print(pydantic.__version__)"` → shows 2.x
3. `pytest tests/ -v --tb=short` → all tests pass
4. `mypy src/` → no type errors
5. Live scripture retrieval: `python -c "from src.scripture.retrieval import ScriptureRetriever; r = ScriptureRetriever(); print(r.retrieve('Romans 8:15', 'NASB').text)"` → returns verse text
6. Registry restart test: run test in test_registry.py named `test_registry_survives_restart`
7. `cat constitution.md` → contains operator-approved marker or operator sign-off

---

## Gatekeeper Checklist

Gatekeeper reviews this phase plan before Builder execution begins.

- [ ] Objective is clear and scoped correctly for Phase 001
- [ ] All required schema fields are specified (section approval_status, GroundingMap entries, PrayerTraceMap entries)
- [ ] Mock RAG interface is truly agnostic — real implementation can swap in without changing call sites
- [ ] Scripture retrieval fallback chain matches FR-59 exactly (primary retry → secondary → import → alert)
- [ ] Series Registry covers all TC-05 requirements (quotes, scriptures, author distribution, persistence, backup)
- [ ] `constitution.md` must be approved before any implementation — this constraint is enforced
- [ ] All 5 commit points have: files to stage, exact commit command, verification steps, rollback instructions
- [ ] Acceptance criteria are measurable and testable
- [ ] PDF spike is non-blocking but has a deadline (before Phase 003)

**Decision**: APPROVE
**Approval Marker**: OPERATOR_APPROVED_FOR_PHASE_001

---

## Document History

| Version | Date | Changes |
|---------|------|---------|
| 1.0 | 2026-02-24 | Initial phase plan — Iteration 1 |
